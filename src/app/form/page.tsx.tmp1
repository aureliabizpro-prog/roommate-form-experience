'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { useFormStore } from '@/hooks/useFormStore';
import { useTracking } from '@/hooks/useTracking';
import { formSchema, FormData } from '@/lib/formSchema';
import { motion, AnimatePresence } from 'framer-motion';

// Import components
import TextInput from '@/components/TextInput';
import RadioGroup from '@/components/RadioGroup';
import CheckboxGroup from '@/components/CheckboxGroup';
import LongTextArea from '@/components/LongTextArea';
import DatePicker from '@/components/DatePicker';
import EmailInput from '@/components/EmailInput';

const sections = [
    // ... (Full sections data as before)
    { id: 1, title: "å¥½å®¤å‹housemate_twÂ® æ‰¾å®¤å‹åª’åˆé«”é©—", emoji: "ğŸ™Œ", questions: [{id: 1, key: 'email', text: "Email", type: "email", required: true}] },
    { id: 2, title: "ğŸ§©ç”Ÿæ´»ç¿’æ…£èˆ‡ç›¸è™•åå¥½", emoji: "ğŸ§©", questions: [
        {id: 2, key: 'q2_routine', text: "ä½ çš„ä½œæ¯å¤§è‡´æ˜¯ï¼Ÿ", type: "radio", required: true, options: ["æ¥µåº¦æ—©ç¡æ—©èµ·ï¼ˆ9â€“10 é»ç¡ï¼Œ5â€“6 é»èµ·ï¼‰", "åæ—©ç¡æ—©èµ·ï¼ˆ11 é»å‰ç¡ï¼Œ7 é»èµ·ï¼‰", "æ­£å¸¸ä½œæ¯ï¼ˆä¸æ—©ä¸æ™šï¼‰", "åæ™šç¡æ™šèµ·ï¼ˆå‡Œæ™¨ 1â€“2 é»ç¡ï¼Œ9â€“10 é»èµ·ï¼‰", "æ¥µåº¦å¤œè²“ï¼ˆ3 é»æ‰ç¡ï¼Œ11 é»èµ·ï¼‰"]},
        {id: 3, key: 'q3_bathroom_preference', text: "æ‚¨å°è¡›æµ´è¨­å‚™çš„ä½¿ç”¨æ™‚é–“æ˜¯å¦æœ‰å›ºå®šæˆ–ä¸å¯å¦¥å”çš„åå¥½ï¼Ÿ", type: "radio", required: true, options: ["å› ç‚ºä¸Šç­é—œä¿‚ï¼Œæœ‰å›ºå®šä¸”ä¸å¯å¦¥å”çš„æ™‚æ®µ", "æœ‰åå¥½çš„æ™‚æ®µï¼Œä½†è‹¥å®¤å‹æœ‰éœ€æ±‚ï¼Œå¯æå‰å‘ŠçŸ¥ä¸¦å”èª¿ã€‚", "å°ä½¿ç”¨æ™‚é–“å®Œå…¨æ²’æœ‰é™åˆ¶æˆ–åå¥½ï¼Œéš¨æ™‚å¯ç”¨å³å¯ã€‚", "å½ˆæ€§é«˜ï¼Œåªè¦èƒ½ä½¿ç”¨å°±å¥½ï¼Œä¸ä»‹æ„éŒ¯é–‹å®¤å‹æ™‚æ®µã€‚", "æœƒä¸»å‹•è¦åŠƒä½¿ç”¨æ™‚é–“ï¼Œä»¥é¿é–‹å®¤å‹çš„ç†±é–€æ™‚æ®µ"]},
        {id: 4, key: 'q4_cleaning_habits', text: "ä½ å¹³å¸¸å°å…¬å…±ç©ºé–“çš„æ‰“æƒç¿’æ…£æ˜¯ï¼Ÿ", type: "radio", required: true, options: ["å¾ˆéš¨æ€§ï¼Œæ²’æœ‰å›ºå®šæƒåœ°æ™‚é–“", "é«’äº†å†æƒï¼Œç´„å…©ä¸‰é€±ä¸€æ¬¡", "æ²’å›ºå®šç¿’æ…£ï¼Œä½†é¡˜æ„é…åˆå¤§å®¶å…±è­˜", "å›ºå®šä¸€é€±æ‰“æƒä¸€æ¬¡", "çœ‹åˆ°é«’å°±ç«‹åˆ»æƒ"]},
        {id: 5, key: 'q5_friends_over', text: "å°æ–¼å®¤å‹å¸¶æœ‹å‹å›å®¶ï¼Œä½ çš„æ¥å—ç¨‹åº¦æ˜¯ï¼Ÿ", type: "radio", required: true, options: ["å®Œå…¨ä¸å¸Œæœ›å¸¶äººå›å®¶", "å¶çˆ¾å¯ä»¥ï¼Œä½†è¦å…ˆè¬›ä¸€è²", "OKï¼Œåªè¦äº’ç›¸å°Šé‡å°±å¥½", "å¸¸å¸¸å¯ä»¥å¸¶äººï¼Œåªè¦ç°¡å–®èªªä¸€ä¸‹", "æ²’é™åˆ¶ï¼Œéš¨æ™‚éƒ½èƒ½å¸¶"]},
        {id: 6, key: 'q6_pets', text: "å°æ–¼å®¤å‹é¤Šå¯µç‰©ï¼Œä½ çš„æƒ³æ³•æ˜¯ï¼Ÿ", type: "radio", required: true, options: ["å®Œå…¨ä¸èƒ½æ¥å—", "å‹‰å¼·æ¥å—ï¼Œä½†å¸Œæœ›å¯µç‰©ä¸è¦åœ¨å…¬å…±å€åŸŸè·‘ä¾†è·‘å»", "OKï¼Œåªè¦æœ‰æ¸…æ½”ã€å®‰éœçš„è¦ç¯„å°±å¥½", "å–œæ­¡å¯µç‰©ï¼Œè¦ºå¾—æœ‰è²“ç‹—å¾ˆå¥½", "è‡ªå·±æœ‰é¤Šï¼è¶…æ„›å‹•ç‰©ï¼Œå®Œå…¨æ²’å•é¡Œ"]}
    ]},
    // q7 is now handled conditionally
    { id: 4, title: "ğŸ§©ç”Ÿæ´»ç¿’æ…£èˆ‡ç›¸è™•åå¥½", emoji: "ğŸ§©", questions: [
        {id: 8, key: 'q8_noise_sensitivity', text: "æ‚¨å°ç”Ÿæ´»å™ªéŸ³çš„æ•æ„Ÿåº¦å¦‚ä½•ï¼Ÿ", type: "radio", required: true, options: ["ä»»ä½•ç´°å¾®è²éŸ¿éƒ½æœƒåš´é‡å½±éŸ¿æˆ‘çš„ä¼‘æ¯æˆ–å°ˆæ³¨ã€‚", "ä¼‘æ¯æˆ–å°ˆæ³¨æ™‚éœ€è¦ç›¸å°å®‰éœçš„ç’°å¢ƒï¼Œå®¹æ˜“è¢«å¹²æ“¾ã€‚", "è¼•å¾®çš„èƒŒæ™¯è²éŸ¿å¯æ¥å—ï¼Œä½†å¤§è²æˆ–æŒçºŒçš„å™ªéŸ³æœƒå—å½±éŸ¿ã€‚", "ä¸€èˆ¬ç”Ÿæ´»å™ªéŸ³ä¸æœƒå½±éŸ¿æˆ‘ï¼Œé©æ‡‰åŠ›è¼ƒå¼·ã€‚", "å³ä½¿æœ‰è²éŸ³ä¹Ÿèƒ½æ­£å¸¸ä¼‘æ¯æˆ–å·¥ä½œï¼Œå¹¾ä¹ä¸å—å™ªéŸ³å½±éŸ¿ã€‚"]},
        {id: 9, key: 'q9_roommate_interaction', text: "ä½ ç†æƒ³ä¸­çš„å®¤å‹ç›¸è™•æ–¹å¼æ˜¯ï¼Ÿ", type: "radio", required: true, options: ["å„ä½å„çš„ã€äº’ä¸æ‰“æ“¾", "æœ‰åŸºæœ¬ç¦®è²Œï¼Œæ‰“æ‹›å‘¼å°±å¥½", "å¶çˆ¾æœƒèŠå¤©ï¼Œé©åº¦äº’å‹•", "å¸¸å¸¸ä¸€èµ·åšäº‹ï¼Œé—œä¿‚ä¸éŒ¯", "å¾ˆç†Ÿï¼Œåƒæœ‹å‹æˆ–å®¶äººä¸€æ¨£"]},
        {id: 10, key: 'q10_renting_experience', text: "ä½ ä»¥å‰æœ‰è·Ÿåˆ¥äººåˆç§Ÿçš„ç¶“é©—å—?", type: "radio", required: true, options: ["å¾æœªæœ‰é", "æœ‰éåˆç§Ÿç¶“é©—ï¼Œä½†æ™‚é–“ä¸é•· (ä¸€å¹´å·¦å³)", "æœ‰éåˆç§Ÿç¶“é©—ï¼Œæ™‚é–“è¼ƒé•· (ä¸€å¹´ä»¥ä¸Š)", "ç›®å‰æ­£èˆ‡å®¤å‹åˆç§Ÿä¸­ï¼Œä¸¦å°‹æ‰¾æ–°çš„åˆç§Ÿæ©Ÿæœƒ"]}
    ]},
    { id: 5, title: "ğŸ‘¤åŸºæœ¬è³‡æ–™è£œå……", emoji: "ğŸ‘¤", questions: [
        {id: 11, key: 'q11_gender', text: "ä½ çš„ç”Ÿç†æ€§åˆ¥", type: "radio", required: true, options: ["ç”·", "å¥³", "ä¸é¡˜é€éœ²"]},
        {id: 12, key: 'q12_gender_identity', text: "ä½ çš„æ€§åˆ¥èªåŒ", type: "radio", required: true, options: ["ç”·", "å¥³", "æˆ‘ä¸æƒ³é€éœ²", "éäºŒå…ƒæ€§åˆ¥", "å…¶ä»–"]}
    ]},
    { id: 6, title: "ğŸ‘¤åŸºæœ¬è³‡æ–™è£œå……", emoji: "ğŸ‘¤", questions: [{id: 13, key: 'q13_roommate_gender_preference', text: "æ‚¨å¸Œæœ›å°‹æ‰¾ä»€éº¼æ€§åˆ¥çš„å®¤å‹ï¼Ÿ", type: "checkbox", required: true, options: ["é™æ€§åˆ¥èªåŒç‚ºç”·æ€§", "é™æ€§åˆ¥èªåŒç‚ºå¥³æ€§", "ä¸æ‹˜", "é™ç”Ÿç†ç”·", "é™ç”Ÿç†å¥³", "éƒ½å¯ä»¥"]}] },
    { id: 7, title: "ğŸ‘¤åŸºæœ¬è³‡æ–™è£œå……", emoji: "ğŸ‘¤", questions: [
        {id: 14, key: 'q14_location', text: "ä½ æ›´æƒ³ç§Ÿä½åœ¨å“ªè£¡ï¼Ÿ", placeholder: "æœ€å¤š 3 å€‹åœ°å€ï¼Œä¾‹å¦‚ï¼šå°åŒ—å¸‚å¤§å®‰å€ã€æ–°åŒ—å¸‚æ¿æ©‹å€", type: "long_text", required: true},
        {id: 15, key: 'q15_rent_budget', text: "æ‚¨å€‹äººæœŸæœ›çš„æœˆç§Ÿé‡‘åˆ†æ”¤ç¯„åœæ˜¯ï¼Ÿ", type: "radio", required: true, options: ["$8,000 ä»¥ä¸‹", "$8,000 - $10,000", "$10,001 - $12,000", "$12,001 - $15,000", "$15,001 - $18,000", "$18,001 - $22,000", "$22,001 ä»¥ä¸Š"]},
        {id: 16, key: 'q16_move_in_date', text: "æ‚¨è¨ˆç•«ä¸­çš„èµ·ç§Ÿæ—¥?", type: "date", required: true},
        {id: 17, key: 'q17_allergies', text: "æ‚¨æ˜¯å¦æœ‰ä»»ä½•éæ•åŸï¼Ÿ", type: "checkbox", required: true, options: ["ç„¡", "æœ‰ç‰¹å®šçš„é£Ÿç‰©", "å°å¯µç‰©æ¯›é«®/çš®å±‘", "å¡µèŸ", "èŠ±ç²‰", "æ¸…æ½”åŠ‘/åŒ–å­¸å“", "å…¶ä»–"]},
        {id: 18, key: 'q18_smoking_habit', text: "æ‚¨æ˜¯å¦æœ‰æŠ½è¸ç¿’æ…£ï¼Ÿ", type: "radio", required: true, options: ["æ²’æœ‰", "æœ‰ï¼Œä½†æˆ‘æœƒéµå®ˆå”å•†å¾Œçš„å±…ä½å…¬ç´„ï¼Œä¸åœ¨å®¤å…§æŠ½è¸", "æœ‰ï¼Œæœ‰æ™‚å€™ç„¡æ³•é¿å…åœ¨å®¤å…§æŠ½è¸"]}
    ]},
    { id: 8, title: "é‚„æœ‰ä»€éº¼æƒ³è£œå……çš„å—ï¼ŸğŸ’¬", emoji: "ğŸ’¬", questions: [{id: 19, key: 'q19_additional_notes', text: "è£œå……èªªæ˜", placeholder: "å¯ä»¥æ˜¯ä½ å°åˆç§Ÿçš„æœŸå¾…ã€ä¹Ÿå¯ä»¥æ˜¯ä¸€æ®µç°¡çŸ­çš„è‡ªæˆ‘ä»‹ç´¹ï¼Œæˆ–è€…MBTIã€æ˜Ÿåº§åˆ†äº«éƒ½å¯ä»¥å–”ï½", type: "long_text", required: false}] },
    { id: 9, title: "ğŸ™Œ æœ€å¾Œ", emoji: "ğŸ™Œ", questions: [] }
];

// Special question that is conditionally rendered
const conditionalQuestion = { id: 7, key: 'q7_bathroom_schedule', text: "æ‚¨ä¸å¯å¦¥å”çš„è¡›æµ´ä½¿ç”¨æ™‚æ®µ", placeholder: "ä¾‹å¦‚ï¼šå¹³æ—¥æ—©ä¸Š 7:30-8:00ï¼Œæ™šä¸Š9:00-9:30", type: "long_text", required: false, sectionEmoji: 'â°' };

const allQuestions = sections.flatMap(s =>
    s.questions.map(q => ({
        ...q,
        sectionTitle: s.title,
        sectionEmoji: s.emoji ?? s.title[0],
    }))
);
const totalQuestions = allQuestions.length;

type SectionQuestionMeta = {
    sectionId: number;
    isLastInSection: boolean;
};

const questionSectionMeta: Record<string, SectionQuestionMeta> = {};
sections.forEach(section => {
    section.questions.forEach((q, index) => {
        questionSectionMeta[q.key as string] = {
            sectionId: section.id,
            isLastInSection: index === section.questions.length - 1,
        };
    });
});

const progressMessages = [
    "æ—…ç¨‹é–‹å§‹ï¼è®“æˆ‘å€‘èªè­˜çœŸå¯¦çš„ä½ ã€‚", // 0 (Email)
    "ç”Ÿæ´»æ­¥èª¿ï¼Œæ˜¯å’Œè«§å…±è™•çš„ç¬¬ä¸€æ­¥ã€‚", // 1 (q2 ä½œæ¯)
    "ä½ çš„è¡›æµ´åå¥½ï¼Œæˆ‘å€‘æ­£åœ¨è†è½ã€‚", // 2 (q3 è¡›æµ´åå¥½)
    "ç¶­æŒæ•´æ½”ï¼Œå¾ç¿’æ…£é–‹å§‹ã€‚", // 3 (q4 æ‰“æƒç¿’æ…£)
    "æ­¡è¿å¥½å‹ï¼Œä¹Ÿæ˜¯ä¸€é–€è—è¡“ã€‚", // 4 (q5 å¸¶æœ‹å‹)
    "æ¯›å°å­©çš„ç·£åˆ†ï¼Œå¾é€™è£¡é–‹å§‹ã€‚", // 5 (q6 é¤Šå¯µç‰©)
    "å™ªéŸ³æ•æ„Ÿåº¦ï¼Œæ˜¯åˆç§Ÿçš„éš±å½¢æ®ºæ‰‹å—ï¼Ÿ", // 6 (q8 å™ªéŸ³)
    "ä½ èˆ‡å®¤å‹çš„ç†æƒ³è·é›¢æ˜¯ï¼Ÿ", // 7 (q9 ç›¸è™•æ–¹å¼)
    "éå¾€ç¶“é©—ï¼Œå¡‘é€ æ›´å¥½çš„æœªä¾†ã€‚", // 8 (q10 åˆç§Ÿç¶“é©—)
    "æ€§åˆ¥èªåŒï¼Œé‡è¦çš„å€‹äººè³‡è¨Šã€‚", // 9 (q11 ç”Ÿç†æ€§åˆ¥)
    "ç†è§£èˆ‡å°Šé‡ï¼Œæ˜¯å°‹æ‰¾å®¤å‹çš„ç¬¬ä¸€æ­¥ã€‚", // 10 (q12 æ€§åˆ¥èªåŒ)
    "ç²¾æº–é…å°ï¼Œå¾æ˜ç¢ºåå¥½é–‹å§‹ã€‚", // 11 (q13 å®¤å‹æ€§åˆ¥åå¥½)
    "åœ°é»ï¼åœ°é»ï¼åœ°é»ï¼ä½ çš„ç†æƒ³è½è…³è™•åœ¨å“ªï¼Ÿ", // 12 (q14 åœ°å€)
    "é—œæ–¼é ç®—ï¼Œæˆ‘å€‘ä¾†å¥½å¥½èŠèŠã€‚", // 13 (q15 ç§Ÿé‡‘é ç®—)
    "æœŸå¾…ä½•æ™‚å±•é–‹æ–°ç”Ÿæ´»ï¼Ÿ", // 14 (q16 èµ·ç§Ÿæ—¥)
    "ä½ çš„å¥åº·ï¼Œæˆ‘å€‘ä¸€èµ·å®ˆè­·ã€‚", // 15 (q17 éæ•åŸ)
    "å¦èª æºé€šï¼Œå…±äº«èˆ’é©ç©ºé–“ã€‚", // 16 (q18 æŠ½è¸)
    "æœ€å¾Œä¸€å“©è·¯ï¼èªªèªªä½ çš„æ•…äº‹ã€‚", // 17 (q19 è£œå……èªªæ˜)
    "å®Œç¾é…å°ï¼Œå³å°‡æ­æ›‰ï¼" // 18 (å®Œæˆé )
];

type QuestionConfig = {
    key: keyof FormData | string;
    type: 'email' | 'text' | 'radio' | 'checkbox' | 'long_text' | 'date' | string;
    text: string;
    required?: boolean;
    options?: string[];
    placeholder?: string;
    sectionEmoji?: string;
    sectionTitle?: string;
};

const questionEmojiMap: Record<string, string> = {
    email: 'âœ‰ï¸',
    q2_routine: 'â°',
    q3_bathroom_preference: 'ğŸš¿',
    q4_cleaning_habits: 'ğŸ§¹',
    q5_friends_over: 'ğŸ‘¥',
    q6_pets: 'ğŸ¾',
    q7_bathroom_schedule: 'ğŸ“…',
    q8_noise_sensitivity: 'ğŸ”Š',
    q9_roommate_interaction: 'ğŸ¤',
    q10_renting_experience: 'ğŸ“–',
    q11_gender: 'âš§ï¸',
    q12_gender_identity: 'ğŸŒˆ',
    q13_roommate_gender_preference: 'ğŸ ',
    q14_location: 'ğŸ“',
    q15_rent_budget: 'ğŸ’°',
    q16_move_in_date: 'ğŸ“†',
    q17_allergies: 'ğŸŒ¸',
    q18_smoking_habit: 'ğŸš­',
    q19_additional_notes: 'ğŸ’¬',
};

export default function FormPage() {
    const router = useRouter();
    const { trackEvent } = useTracking();
    const { formData, setFormData, resetForm } = useFormStore();
    const [currentQuestion, setCurrentQuestion] = useState(0);
    const [error, setError] = useState<string | null>(null);
    const [direction, setDirection] = useState(1);
    const [hasSubmitted, setHasSubmitted] = useState(false);

    useEffect(() => {
        const handleBeforeUnload = () => {
            if (!hasSubmitted && currentQuestion > 0 && currentQuestion < totalQuestions) {
                trackEvent({ action: 'form_abandoned', step: currentQuestion + 1 });
            }
        };

        if (typeof window !== 'undefined') {
            window.addEventListener('beforeunload', handleBeforeUnload);
        }

        return () => {
            if (typeof window !== 'undefined') {
                window.removeEventListener('beforeunload', handleBeforeUnload);
            }
        };
    }, [hasSubmitted, currentQuestion, trackEvent]);

    const handleNext = () => {
        const question = allQuestions[currentQuestion];
        if (question.required) {
            const value = formData[question.key as keyof FormData];
            const validationResult = formSchema.pick({ [question.key]: true }).safeParse({ [question.key]: value });
            if (!validationResult.success) {
                setError(validationResult.error.issues[0].message);
                return;
            }
        }
        
        setError(null);
        trackEvent({ action: `Q${question.id}_${question.key}_answered` });

        const sectionInfo = questionSectionMeta[question.key as string];
        if (sectionInfo?.isLastInSection) {
            trackEvent({ action: `section_${sectionInfo.sectionId}_completed` });
        }
        setDirection(1);

        if (currentQuestion < totalQuestions) {
            setCurrentQuestion(currentQuestion + 1);
        }
    };

    const handleBack = () => {
        if (currentQuestion > 0) {
            setDirection(-1);
            setCurrentQuestion(currentQuestion - 1);
        }
    };
    
    const handleSubmit = async () => {
        // è‹¥æœªè§¸ç™¼é¡¯ç¤º q7 çš„æ¢ä»¶ï¼Œé¿å…é€å‡ºèˆŠçš„/éš±è—çš„ç­”æ¡ˆ
        const shouldShowQ7 =
            formData.q3_bathroom_preference === 'å› ç‚ºä¸Šç­é—œä¿‚ï¼Œæœ‰å›ºå®šä¸”ä¸å¯å¦¥å”çš„æ™‚æ®µ';
        const submissionData = { ...formData };
        const dataForValidation = (() => {
            if (shouldShowQ7) return submissionData;
            const { q7_bathroom_schedule, ...rest } = submissionData;
            void q7_bathroom_schedule;
            return rest;
        })();

        const validationResult = formSchema.safeParse(dataForValidation);
        if (!validationResult.success) {
            const firstErrorKey = validationResult.error.issues[0].path[0] as string;
            const errorQuestionIndex = allQuestions.findIndex(q => q.key === firstErrorKey);
            if (errorQuestionIndex !== -1) {
                setCurrentQuestion(errorQuestionIndex);
                setError(validationResult.error.issues[0].message);
            }
            return;
        }

        try {
            const response = await fetch('/api/submit-form', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(validationResult.data),
            });
            const resJson = await response.json();
            if (response.ok) {
                trackEvent({ action: 'form_submission_success' });
                setHasSubmitted(true);
                resetForm();
                router.push(`/success?userId=${resJson.userId}`);
            } else {
                alert('æäº¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
            }
        } catch {
            alert('ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯é€£ç·šã€‚');
        }
    };

    const renderQuestion = (question: QuestionConfig, isConditional = false) => {
        const { key, type, text, required, options, placeholder, sectionEmoji, sectionTitle } = question;
        const value = formData[key as keyof FormData];

        const handleChange = (val: string | string[]) => {
            setFormData({ [key]: val } as Partial<FormData>);
            if (error) setError(null);
        };

        const questionEmoji =
            questionEmojiMap[key as string] ??
            sectionEmoji ??
            'âœ¨';

        return (
            <div className="w-full">
                <div className="flex items-start gap-3 mb-3">
                    {!isConditional && (
                        <span className="flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-2xl bg-orange-50 text-3xl sm:h-14 sm:w-14 sm:text-4xl">
                            {questionEmoji}
                        </span>
                    )}
                    <div className="flex-1">
                        {!isConditional && sectionTitle && (
                            <p className="text-[11px] uppercase tracking-wide text-slate-400 mb-1">
                                {sectionTitle}
                            </p>
                        )}
                        <h3 className={isConditional ? 'text-base text-slate-700' : 'text-lg sm:text-xl font-medium text-gray-800'}>
                            {text}
                            {required && <span className="text-red-500 ml-1">*</span>}
                        </h3>
                    </div>
                </div>

                <div className="mt-2">
                    {
                        {
                            'email': (
                                <EmailInput
                                    question=""
                                    value={(value as string) || ''}
                                    onChange={handleChange}
                                    required={required ?? false}
                                    placeholder={placeholder}
                                />
                            ),
                            'text': (
                                <TextInput
                                    question=""
                                    value={(value as string) || ''}
                                    onChange={handleChange}
                                    required={required ?? false}
                                    placeholder={placeholder}
                                />
                            ),
                            'radio': (
                                <RadioGroup
                                    question=""
                                    options={options ?? []}
                                    selectedValue={(value as string) || ''}
                                    onChange={handleChange}
                                    required={required ?? false}
                                />
                            ),
                            'checkbox': (
                                <CheckboxGroup
                                    question=""
                                    options={options ?? []}
                                    selectedValues={(value as string[]) || []}
                                    onChange={handleChange}
                                    required={required ?? false}
                                />
                            ),
                            'long_text': (
                                <LongTextArea
                                    question=""
                                    value={(value as string) || ''}
                                    onChange={handleChange}
                                    required={required ?? false}
                                    placeholder={placeholder}
                                />
                            ),
                            'date': (
                                <DatePicker
                                    question=""
                                    value={(value as string) || ''}
                                    onChange={handleChange}
                                    required={required ?? false}
                                />
                            ),
                        }[type]
                    }
                </div>
            </div>
        )
    }
    
	    const isComplete = currentQuestion >= totalQuestions;
    const question = !isComplete ? allQuestions[currentQuestion] : null;
    const progress = (Math.min(currentQuestion, totalQuestions) / totalQuestions) * 100;
    const progressText =
        progressMessages[Math.min(currentQuestion, progressMessages.length - 1)] ||
        'å°±å¿«å®Œæˆäº†ï¼';

    const showQ7Conditional =
        !isComplete &&
        question?.key === 'q3_bathroom_preference' &&
        formData.q3_bathroom_preference === 'å› ç‚ºä¸Šç­é—œä¿‚ï¼Œæœ‰å›ºå®šä¸”ä¸å¯å¦¥å”çš„æ™‚æ®µ';

    const variants = {
        enter: (direction: number) => ({ x: direction > 0 ? '100%' : '-100%', opacity: 0, scale: 0.9 }),
        center: { x: 0, opacity: 1, scale: 1 },
        exit: (direction: number) => ({ x: direction < 0 ? '100%' : '-100%', opacity: 0, scale: 0.9 }),
    };
    
	    return (
	        <main className="flex flex-col h-screen w-full overflow-hidden bg-slate-50">
	             <div className="p-3 sm:p-4 w-full max-w-2xl mx-auto">
	                <div className="flex justify-between items-center mb-2 sm:mb-3">
	                    <p className="text-xs sm:text-base font-semibold text-orange-600 leading-tight">{progressText}</p>
	                    <p className="text-xs sm:text-sm font-bold text-gray-800 bg-white px-3 py-1 rounded-full shadow-sm">
	                        {Math.min(currentQuestion + 1, totalQuestions)} / {totalQuestions}
	                    </p>
	                </div>
	                <div className="w-full bg-orange-100/60 rounded-full h-2.5 sm:h-3">
	                    <motion.div
	                        className="h-2.5 sm:h-3 rounded-full bg-gradient-to-r from-orange-300 via-orange-400 to-green-500 shadow-sm"
	                        animate={{ width: `${progress}%` }}
	                        transition={{ duration: 0.3 }}
	                    />
	                </div>
	            </div>

            <div className="flex-grow flex items-start sm:items-center justify-center px-3 sm:px-4 py-2 overflow-y-auto">
                <AnimatePresence initial={false} custom={direction} mode="wait">
                    <motion.div
                        key={currentQuestion}
                        variants={variants}
                        custom={direction}
                        initial="enter"
                        animate="center"
                        exit="exit"
                        transition={{ type: "spring", stiffness: 200, damping: 25 }}
                        className="w-full max-w-2xl"
                    >
                        {!isComplete ? (
                             <div className="bg-white rounded-xl sm:rounded-2xl shadow-xl p-4 sm:p-6 md:p-8 relative">
                                {question && renderQuestion(question)}
                                {showQ7Conditional && (
                                    <motion.div
                                        initial={{ opacity: 0, height: 0 }}
                                        animate={{ opacity: 1, height: 'auto' }}
                                        exit={{ opacity: 0, height: 0 }}
                                        transition={{ duration: 0.3 }}
                                        className="mt-4 pt-4 border-t border-slate-200"
                                    >
                                        {renderQuestion(conditionalQuestion, true)}
                                    </motion.div>
                                )}
                                {error && <p className="text-red-500 text-sm mt-4 ml-0 sm:ml-9 bg-red-50 p-3 rounded-lg">{error}</p>}
                            </div>
                        ) : (
                            <div className="bg-white rounded-xl sm:rounded-2xl shadow-xl p-6 sm:p-8 text-center">
                                <h2 className="text-2xl sm:text-3xl font-bold text-gray-800 mb-3 sm:mb-4">ğŸ™Œ æ‚¨å·²å®Œæˆæ‰€æœ‰å•é¡Œï¼</h2>
                                <p className="text-sm sm:text-base text-slate-600 mb-6 sm:mb-8">æº–å‚™å¥½çœ‹çœ‹æ‚¨çš„å°ˆå±¬çµ±è¨ˆï¼Œä¸¦é–‹å§‹åª’åˆäº†å—ï¼Ÿ</p>
                                <motion.button
                                    whileHover={{ scale: 1.05 }}
                                    whileTap={{ scale: 0.95 }}
                                    onClick={handleSubmit}
                                    className="w-full sm:w-auto px-8 py-4 bg-green-500 text-white font-bold text-base sm:text-lg rounded-xl shadow-lg hover:bg-green-600 active:bg-green-700 transition-colors"
                                >
                                    å®Œæˆä¸¦æäº¤
                                </motion.button>
                            </div>
                        )}
                    </motion.div>
                </AnimatePresence>
            </div>

            <div className="p-3 sm:p-4 flex justify-between items-center gap-3 max-w-2xl w-full mx-auto sticky bottom-0 bg-slate-50/95 backdrop-blur-sm z-10 border-t border-slate-200/50">
                <motion.button
                    onClick={handleBack}
                    disabled={currentQuestion === 0}
                    className="flex-1 sm:flex-none min-h-[48px] px-5 sm:px-6 py-3 bg-slate-300 text-gray-800 font-medium rounded-xl disabled:opacity-40 disabled:cursor-not-allowed hover:bg-slate-400 active:bg-slate-500 transition-colors shadow-sm"
                    whileTap={{ scale: 0.97 }}
                >
                    ä¸Šä¸€æ­¥
                </motion.button>
                {currentQuestion < totalQuestions && (
                    <motion.button
                        onClick={handleNext}
                        className="flex-1 sm:flex-none min-h-[48px] px-5 sm:px-6 py-3 bg-orange-300 text-white font-semibold rounded-xl hover:bg-orange-400 active:bg-orange-500 transition-colors shadow-md"
                        whileTap={{ scale: 0.97 }}
                    >
                        ä¸‹ä¸€æ­¥
                    </motion.button>
                )}
            </div>
        </main>
    );
}
